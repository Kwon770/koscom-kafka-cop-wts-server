name: ğŸš€ KOSCOM Kafka COP Consumer Production CI/CD

on:
  push:
    branches:
      - main

env:
  ENVIRONMENT: prod
  IMAGE_NAME: sckwon770/koscom-kafka-cop-wts-was
  SERVICE_NAME: koscom-kafka-cop-wts-was

jobs:
  prepare-variables:
    name: ì›Œí¬í”Œë¡œìš° ë³€ìˆ˜ ì¤€ë¹„
    runs-on: ubuntu-latest
    outputs:
      image-name: ${{ steps.setup-env.outputs.image-name }}
      image-tag: ${{ steps.setup-env.outputs.image-tag }}
      environment: ${{ steps.setup-env.outputs.environment }}
      service-name: ${{ steps.setup-env.outputs.service-name }}
    steps:
      - name: GitHubì—ì„œ ë ˆí¬ ë°›ì•„ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: ë³€ìˆ˜ ì„¤ì •
        id: setup-env
        run: |
          echo "image-name=${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
          echo "image-tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "environment=${{ env.ENVIRONMENT }}" >> $GITHUB_OUTPUT
          echo "service-name=${{ env.SERVICE_NAME }}" >> $GITHUB_OUTPUT

  build-and-push:
    name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: [prepare-variables]
    outputs:
      image-url: ${{ steps.build-image.outputs.image-url }}
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ì›Œí¬í”Œë¡œìš° ì‹œì‘ ì•Œë¦¼
        if: success()
        run: |
          echo "ğŸš€ Production ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ë°°í¬ í™˜ê²½: ${{ needs.prepare-variables.outputs.environment }}"
          echo "ë°°í¬ì: ${{ github.event.pusher.name }}"
          echo "ì´ë¯¸ì§€: ${{ needs.prepare-variables.outputs.image-name }}:${{ needs.prepare-variables.outputs.image-tag }}"

      - name: GitHubì—ì„œ ë ˆí¬ ë°›ì•„ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Docker Hubì— ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Gradle ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: Gradle ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
        run: ./gradlew clean build test

      - name: Jibë¡œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build-image
        env:
          ACTIVE_PROFILE: prod
        run: |
          echo "ğŸ”¨ Jibì„ ì‚¬ìš©í•˜ì—¬ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì‹œì‘..."
          ./gradlew jib \
            -Djib.to.image=${{ needs.prepare-variables.outputs.image-name }}:${{ needs.prepare-variables.outputs.image-tag }} \
            -Djib.to.tags=latest \
            -Dspring.profiles.active=prod
          
          echo "image-url=${{ needs.prepare-variables.outputs.image-name }}:${{ needs.prepare-variables.outputs.image-tag }}" >> $GITHUB_OUTPUT
          echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ: ${{ needs.prepare-variables.outputs.image-name }}:${{ needs.prepare-variables.outputs.image-tag }}"

      - name: ë¹Œë“œ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo "âœ… Production ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ!"
          echo "ì´ë¯¸ì§€: ${{ steps.build-image.outputs.image-url }}"

      - name: ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ Production ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "Workflow ë§í¬: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  deploy:
    name: ì„œë²„ ë°°í¬
    runs-on: ubuntu-latest
    needs: [prepare-variables, build-and-push]
    if: success()
    environment: production
    
    permissions:
      contents: read

    steps:
      - name: GitHubì—ì„œ ë ˆí¬ ë°›ì•„ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: ì„œë²„ ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/ec2-user/wts/was
            echo "ğŸš€ KOSCOM Kafka COP Consumer ë°°í¬ ì‹œì‘..."

            # ìƒˆ ì´ë¯¸ì§€ Pull (ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì „ì— ë¯¸ë¦¬ ë‹¤ìš´ë¡œë“œ)
            echo "ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker pull ${{ needs.prepare-variables.outputs.image-name }}:${{ needs.prepare-variables.outputs.image-tag }}

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ Graceful Shutdown
            if [ "$(docker ps -q -f name=${{ needs.prepare-variables.outputs.service-name }})" ]; then
              echo "â¸ï¸  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ Graceful Shutdown ì‹œì‘..."

              # SIGTERM ì „ì†¡ í›„ 5ë¶„ ëŒ€ê¸° (Kafka consumer close, batch flush ì™„ë£Œ ëŒ€ê¸°)
              # Spring Boot graceful shutdownì´ ì‘ë™í•  ìˆ˜ ìˆë„ë¡ ì¶©ë¶„í•œ ì‹œê°„ ë¶€ì—¬
              docker stop --time=300 ${{ needs.prepare-variables.outputs.service-name }}

              echo "âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ìƒ ì¢…ë£Œ ì™„ë£Œ"

              # ì»¨í…Œì´ë„ˆ ì œê±°
              docker rm ${{ needs.prepare-variables.outputs.service-name }}
            else
              echo "â„¹ï¸  ì‹¤í–‰ ì¤‘ì¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤."
            fi

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            docker run -d \
              --name ${{ needs.prepare-variables.outputs.service-name }} \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file .env \
              -e SPRING_PROFILES_ACTIVE=prod \
              --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" \
              --health-interval=10s \
              --health-timeout=5s \
              --health-retries=3 \
              --health-start-period=40s \
              ${{ needs.prepare-variables.outputs.image-name }}:${{ needs.prepare-variables.outputs.image-tag }}

            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ë° í—¬ìŠ¤ì²´í¬
            echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 5

            # í—¬ìŠ¤ì²´í¬ í™•ì¸ (ìµœëŒ€ 10ë¶„ ëŒ€ê¸°)
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ í™•ì¸ ì¤‘..."
            for i in {1..120}; do
              if docker exec ${{ needs.prepare-variables.outputs.service-name }} curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ê¸°ë™ í™•ì¸!"
                break
              fi

              if [ $i -eq 12 ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨! ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
                docker logs --tail 50 ${{ needs.prepare-variables.outputs.service-name }}
                exit 1
              fi

              echo "ëŒ€ê¸° ì¤‘... ($i/12)"
              sleep 5
            done

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker ps -f name=${{ needs.prepare-variables.outputs.service-name }}

            # ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -a -f

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ“ ìµœê·¼ ë¡œê·¸ í™•ì¸:"
            docker logs --tail 20 ${{ needs.prepare-variables.outputs.service-name }}
